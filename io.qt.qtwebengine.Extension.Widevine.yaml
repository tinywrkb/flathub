id: io.qt.qtwebengine.Extension.Widevine
branch: 5.15-21.08
runtime: io.qt.qtwebengine.BaseApp
runtime-version: 5.15-21.08
sdk: org.kde.Sdk
build-extension: true
separate-locales: false
appstream-compose: false
build-options:
  cflags: -I/app/qtwebengine/extensions/Widevine/include
  cxxflags: -I/app/qtwebengine/extensions/Widevine/include
  ldflags: -L/app/qtwebengine/extensions/Widevine/lib
  prefix: /app/qtwebengine/extensions/Widevine
  prepend-path: /app/qtwebengine/extensions/Widevine/bin
  prepend-ld-library-path: /app/qtwebengine/extensions/Widevine/lib
  prepend-pkg-config-path: /app/qtwebengine/extensions/Widevine/lib/pkgconfig
cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
modules:
  - name: widevine
    buildsystem: simple
    build-commands:
      - install -Dm755 apply_extra -t ${FLATPAK_DEST}/bin
    sources:
      - type: extra-data
        filename: widevinecdm-linux.zip
        only-arches:
          - x86_64
        url: https://dl.google.com/widevine-cdm/4.10.2391.0-linux-x64.zip
        sha256: ee01fcd3c0baee6fecd3d7b8ad05101dbfedfa21957735be633ac1d59c4621da
        size: 6328796
      - type: script
        dest-filename: apply_extra
        only-arches:
          - x86_64
        commands:
          - bsdtar -xf widevinecdm-linux.zip
          - rm -f widevinecdm-linux.zip
          - install -dm755 _platform_specific/linux_x64
          - mv libwidevinecdm.so _platform_specific/linux_x64/
      - type: extra-data
        # TODO: f-e-d-c
        filename: cros-recovery.zip
        only-arches:
          - aarch64
        # Acer Chromebook 514 (Spherion) recovery image
        # Version: 96.0.4664.111, Platform version: 14268.67.0
        # https://www.chromium.org/chromium-os/developer-information-for-chrome-os-devices
        # https://cros-updates-serving.appspot.com/
        # https://dl.google.com/dl/edgedl/chromeos/recovery/recovery.conf
        url: https://dl.google.com/dl/edgedl/chromeos/recovery/chromeos_14268.67.0_asurada_recovery_stable-channel_mp-v3.bin.zip
        sha256: 3bd22972f62bed2135201f6846337558cfdf1f7e64439ede0cd226ffbe295d83
        size: 1230349394
      - type: script
        dest-filename: apply_extra
        only-arches:
          - aarch64
        commands:
          # TODO: read part table
          - bsdtar -Oxf cros-recovery.zip 2>/dev/null | dd of=cros.rootfs iflag=fullblock conv=noerror bs=512 skip=1286144 count=4915200
          - /app/lib/x86_64-linux-gnu/p7zip/7z e cros.rootfs opt/google/chrome/libwidevinecdm.so
          - rm -f cros-recovery.zip cros.rootfs
          - install -dm755 _platform_specific/linux_arm64
          - mv libwidevinecdm.so _platform_specific/linux_arm64/
  - name: p7zip
    only-arches:
      - aarch64
    no-autogen: true
    make-args:
      - 7z
    make-install-args:
      - DEST_DIR=/
      - DEST_HOME=${FLATPAK_DEST}
      - DEST_MAN=${FLATPAK_DEST}/share/man
      - DEST_SHARE=${FLATPAK_DEST}/lib/${FLATPAK_ARCH}-linux-gnu/p7zip
    sources:
      - type: archive
        url: https://github.com/jinfeihan57/p7zip/archive/eb1bbb0d0327a103850fec519015986e72a1ebf0.tar.gz
        sha256: cecdaa7e2738ad4594ddddb0c568db1750b7a7ff8433961be8595033d444e3a7
        x-checker-data:
          type: anitya
          project-id: 2583
          stable-only: true
          versions:
            '>': '17.04'
          url-template: https://github.com/jinfeihan57/p7zip/archive/v$version/p7zip-$version.tar.gz
    cleanup:
      - /bin
      - /share
