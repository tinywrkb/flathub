app-id: io.pslab.PSLabDesktop
runtime: org.freedesktop.Platform
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp
base-version: '20.08'
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node14
separate-locales: false
command: pslab-desktop
finish-args:
  - --device=all
  - --device=dri
  - --filesystem=home
  - --filesystem=host
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  # needs electron v11 (chromium v87) or newer with ozone enabled
  # https://github.com/electron/electron/issues/10915
  #- --socket=fallback-x11
  #- --socket=wayland
  - --socket=x11
cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
build-options:
  env:
    - LAPACK=/app/lib
    - BLAS=/app/lib
modules:
  - name: lapack
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DBUILD_SHARED_LIBS=ON
      - -DCBLAS=ON
    sources:
      - type: archive
        url: https://github.com/Reference-LAPACK/lapack/archive/v3.9.1.tar.gz
        sha256: d0085d2caf997ff39299c05d4bacb6f3d27001d25a4cc613d48c1f352b73e7e0
  - python-dependencies.json
  - name: pslab
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/node14/bin
      env:
        npm_config_cache: /run/build/pslab/flatpak-node/npm-cache
        npm_config_nodedir: /usr/lib/sdk/node14
        # TODO: fix offline installation
        # disable this to enable online build
        #npm_config_offline: 'true'
        npm_config_no_save: 'true'
        npm_config_loglevel: silly
      # TODO: fix offline installation
      build-args:
        - --share=network
    build-commands:
      # workaround to regenerate package-lock.json as the upstream one breaks the build process
      #- rm package-lock.json
      #- npm cache clean --force
      #- npm install --package-lock-only --only=production
      - npm install
      - npm run build
      - npm run pack
      - cp -r dist/linux-unpacked /app/pslab
      - install -Dm644 public/app_icon.png /app/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
    sources:
      - type: archive
        url: https://github.com/fossasia/pslab-desktop/archive/v2.8.1.tar.gz
        sha256: 05e11c54260058b13884a48b62446d47d116a895816e31ce50610d752c13d648
      - generated-sources.json
  - name: package
    buildsystem: simple
    build-commands:
      - rm /app/pslab/chrome-sandbox
      - install -Dm755 stub_sandbox /app/pslab/chrome-sandbox
      - install -Dm755 pslab-desktop -t /app/bin/
      - install -Dm644 ${FLATPAK_ID}.desktop -t /app/share/applications/
    sources:
      - type: script
        dest-filename: stub_sandbox
        commands:
          - |
              echo Stub sandbox ignoring command: $@
              exit 1
      - type: file
        path: pslab-desktop
      - type: file
        path: io.pslab.PSLabDesktop.desktop
